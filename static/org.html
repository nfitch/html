<html>
  <meta charset="UTF-8">
  <head>
    <title>Org Chart</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript">
      /***********************************
      * Person fields:
      *    id: unique id for the person
      *    managerId: unique id for the manager
      *    name: Person's name
      *    numDirects: Number of direct reports
      *    numReports: Total number of people that roll up to Person
      *    orgName: [Optional] Friendly name (what they do)
      *    children: Person[]
      *
      * index contains: index[id] => Person
      * org contains: index[""] - pseudo blank person that holds all the top
      *                           level people in the org.  Yes, there are
      *                           sometimes joint CEOs.
      */

      //Ya... globals... sigh...
      var index = {};
      var orgDataPath = "org-data/data.csv";
      var orgJoinPath = "org-data/join.csv";

      //Holds the org and the (for now, single, org joins)
      var org;
      var joins;

      /* ==== Build the org from CSV rows ==== */
      function orgFromRows(rows) {
          for (var i = 0; i < rows.length; ++i) {
              var row = rows[i];

              //Build person
              var person = index[row.id];
              if (!person) {
                  person = {};
                  person.id = row.id;
                  person.children = [];
                  index[person.id] = person;
              }
              person.name = row.name;
              person.managerId = row.manager_id;
              person.title = row.title;
              person.raw = row;

              //Add to the manager
              var manager = index[person.managerId];
              if (!manager) {
                  manager = {};
                  manager.id = person.managerId;
                  manager.children = [];
                  index[manager.id] = manager;
              }
              manager.children.push(person);
          }

          org = index[""];

          //Call back to init now that we have data.
          init();
      }

      /* ==== Helpers ==== */
      function toCamel(s) {
          return s.replace(/([-_][a-z])/ig, ($1) => {
              return $1.toUpperCase()
                  .replace('_', '');
          });
      };

      /* ==== Join data into org structure ==== */
      function orgJoinData(rows) {
          joins = rows;
          for (var i = 0; i < joins.length; ++i) {
              var join = joins[i];

              var node = index[join.id];
              if (!node) {
                  console.error('Attempted join but couldnt find person', join);
                  continue;
              }

              for (key in join) {
                  var newKey = toCamel(key);
                  node[newKey] = join[key];
              }
          }

          //Call back to init now that we have data.
          init();
      }

      /* ==== Add Stats to org ==== */
      function addOrgStats(org) {
          levelStats(org);
      }

      function levelStats(node) {
          //DFS, roll stats from the bottom up.
          node.children.forEach(levelStats);

          //Roll up number of directs and reports
          node.numDirects = node.children.length;
          node.numReports = node.numDirects;
          node.children.forEach(function (child) {
              node.numReports += child.numReports;
          });
      }

      /* ==== Init ==== */
      //Called multiple times as data is loaded.
      function init() {
          if (!org) {
              d3.csv(orgDataPath, orgFromRows);
          } else if (!joins) {
              d3.csv(orgJoinPath, orgJoinData);
          } else {
              org.children.forEach(addOrgStats);
              console.log(org);
          }
      }
    </script>
  </head>
  <body onLoad="init()">
    Hello World!
  </body>
</html>
